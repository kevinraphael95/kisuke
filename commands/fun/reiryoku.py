# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âš¡ reiryoku.py â€” Commande interactive !reiryoku
# Objectif : Mini-jeu zen dâ€™harmonisation de Reiryoku (Ã©nergie spirituelle)
# CatÃ©gorie : Jeux
# AccÃ¨s : Public
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Imports nÃ©cessaires
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import discord
from discord.ext import commands, tasks
from discord.ui import View, Button
import random
from utils.discord_utils import safe_send, safe_edit, safe_respond

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ® Vue interactive Reiryoku
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class ReiryokuView(View):
    def __init__(self, author: discord.User):
        super().__init__(timeout=30)
        self.author = author
        self.level_1 = 0
        self.level_2 = 4
        self.direction_1 = 1
        self.direction_2 = -1
        self.message = None
        self.running = True
        self.result_shown = False
        self.loop.start()
        self.add_item(CanaliserButton(self))

    def build_bar(self, level):
        bar = ["â–«ï¸"] * 5
        bar[level] = "ğŸ”·"
        return "".join(bar)

    def build_embed(self):
        embed = discord.Embed(
            title="ğŸŒ€ Reiryoku â€” Harmonise ton Ã©nergie !",
            description=(
                "Clique sur **Canaliser** quand les deux flux sont alignÃ©s !\n"
                f"**Flux 1** : {self.build_bar(self.level_1)}\n"
                f"**Flux 2** : {self.build_bar(self.level_2)}"
            ),
            color=discord.Color.purple()
        )
        return embed

    @tasks.loop(seconds=0.5)
    async def loop(self):
        if not self.running or self.result_shown:
            return

        self.level_1 += self.direction_1
        self.level_2 += self.direction_2

        if self.level_1 in [0, 4]:
            self.direction_1 *= -1
        if self.level_2 in [0, 4]:
            self.direction_2 *= -1

        if self.message:
            await safe_edit(self.message, embed=self.build_embed(), view=self)

    async def stop_loop(self):
        self.running = False
        self.loop.stop()

    async def show_result(self, interaction: discord.Interaction):
        await self.stop_loop()
        self.result_shown = True

        diff = abs(self.level_1 - self.level_2)
        if diff == 0:
            result = "âœ… Parfaitement synchronisÃ© !"
            color = discord.Color.green()
        elif diff == 1:
            result = "ğŸŸ¢ Bien, mais tu peux faire mieux."
            color = discord.Color.orange()
        else:
            result = "ğŸ”´ DÃ©synchronisation Ã©nergÃ©tique..."
            color = discord.Color.red()

        embed = discord.Embed(
            title="âœ¨ RÃ©sultat de la canalisation",
            description=(
                f"**Flux 1** : {self.build_bar(self.level_1)}\n"
                f"**Flux 2** : {self.build_bar(self.level_2)}\n\n"
                f"{result}"
            ),
            color=color
        )
        await safe_respond(interaction, embed=embed, view=None)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ‹ Bouton "Canaliser"
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class CanaliserButton(Button):
    def __init__(self, view: ReiryokuView):
        super().__init__(label="Canaliser", style=discord.ButtonStyle.success)
        self.view_ref = view

    async def callback(self, interaction: discord.Interaction):
        if interaction.user != self.view_ref.author:
            return await safe_respond(interaction, content="â›” Ce jeu ne t'appartient pas.", ephemeral=True)

        await self.view_ref.show_result(interaction)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  Cog principal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Reiryoku(commands.Cog):
    """
    Commande !reiryoku â€” Harmonise ton Ã©nergie spirituelle au bon moment
    """

    def __init__(self, bot: commands.Bot):
        self.bot = bot

    @commands.command(
        name="reiryoku",
        help="Mini-jeu d'Ã©quilibrage d'Ã©nergie spirituelle.",
        description="Clique quand les deux flux sont alignÃ©s."
    )
    async def reiryoku(self, ctx: commands.Context):
        view = ReiryokuView(ctx.author)
        embed = view.build_embed()
        msg = await safe_send(ctx, embed=embed, view=view)
        view.message = msg


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”Œ Setup du Cog
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def setup(bot: commands.Bot):
    cog = ReiryokuView(bot)
    for command in cog.get_commands():
        if not hasattr(command, "category"):
            command.category = "Fun"
    await bot.add_cog(cog)
