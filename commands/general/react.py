# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“Œ react.py â€” Commande interactive /react et !react
# Objectif : RÃ©agit Ã  un message avec un ou plusieurs emojis (custom animÃ©s ou standards)
# CatÃ©gorie : GÃ©nÃ©ral
# AccÃ¨s : Public
# Cooldown : 1 utilisation / 3 sec / utilisateur
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Imports nÃ©cessaires
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import discord
from discord import app_commands
from discord.ext import commands
from utils.discord_utils import safe_send
import random

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  Cog principal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class ReactCommand(commands.Cog):
    """Commande interactive /react et !react â€” RÃ©agit Ã  un message avec des emojis."""

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Initialisation du cog
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    def __init__(self, bot: commands.Bot):
        self.bot = bot  # RÃ©fÃ©rence au bot

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Fonction interne pour ajouter des rÃ©actions
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async def _react_to_message(
        self,
        channel: discord.abc.Messageable,
        guild: discord.Guild,
        emoji_names: list[str],
        reference_message_id: int = None,
        before_time=None,
    ):
        """
        Ajoute plusieurs rÃ©actions Ã  un message.
        - Si reference_message_id est fourni, rÃ©agit Ã  ce message.
        - Sinon, prend le dernier message du salon (avant before_time si fourni).
        - Supporte les emojis custom du serveur, des autres serveurs et les emojis Unicode standard.
        """
        target_message = None
        try:
            # ğŸ”¹ RÃ©cupÃ©ration du message cible
            if reference_message_id:
                target_message = await channel.fetch_message(reference_message_id)
            else:
                async for msg in channel.history(limit=20, before=before_time):
                    target_message = msg
                    break

            if not target_message:
                # âš ï¸ Aucun message trouvÃ©
                await safe_send(channel, "âŒ Aucun message valide Ã  rÃ©agir.", delete_after=5)
                return

            # ğŸ”¹ Boucle sur tous les emojis Ã  ajouter
            for emoji_name in emoji_names:
                emoji_name_cleaned = emoji_name.strip()
                emoji_lookup = emoji_name_cleaned.strip(":").lower()

                # ğŸ­ Cherche emoji custom sur le serveur actuel
                emoji = next((e for e in guild.emojis if e.name.lower() == emoji_lookup), None)

                # ğŸ”¹ Cherche emoji dans les autres serveurs si non trouvÃ©
                if not emoji:
                    other_guilds = [g for g in self.bot.guilds if g.id != guild.id]
                    for g in random.sample(other_guilds, len(other_guilds)):
                        emoji = next((e for e in g.emojis if e.name.lower() == emoji_lookup and e.available), None)
                        if emoji:
                            break

                try:
                    # âœ… Ajout de la rÃ©action
                    if emoji:  # Emoji custom trouvÃ©
                        await target_message.add_reaction(emoji)
                        print(f"âœ… RÃ©action {emoji} ajoutÃ©e Ã  {target_message.id}")
                    else:      # Emoji Unicode standard
                        await target_message.add_reaction(emoji_name_cleaned)
                        print(f"âœ… RÃ©action {emoji_name_cleaned} ajoutÃ©e Ã  {target_message.id}")
                except discord.HTTPException:
                    # âš ï¸ Impossible dâ€™ajouter lâ€™emoji
                    await safe_send(channel, f"âŒ Impossible dâ€™ajouter `{emoji_name_cleaned}`.", delete_after=5)

        except discord.NotFound:
            await safe_send(channel, "âŒ Message rÃ©fÃ©rencÃ© introuvable.", delete_after=5)
        except Exception as e:
            print(f"âš ï¸ Erreur lors de la rÃ©action : {e}")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commande SLASH
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @app_commands.command(
        name="react",
        description="RÃ©agit avec un ou plusieurs emojis Ã  un message (rÃ©ponse ou dernier du salon)."
    )
    @app_commands.describe(emojis="Liste dâ€™emojis sÃ©parÃ©s par des espaces (custom ou standards)")
    @app_commands.checks.cooldown(1, 3.0, key=lambda i: i.user.id)
    async def slash_react(self, interaction: discord.Interaction, emojis: str):
        await interaction.response.send_message("âœ… RÃ©action en cours...", ephemeral=True)

        try:
            # ğŸ”¹ RÃ©cupÃ©ration du message cible
            message = None
            if interaction.message and interaction.message.reference:
                try:
                    message = await interaction.channel.fetch_message(interaction.message.reference.message_id)
                except discord.NotFound:
                    message = None

            if not message:
                async for msg in interaction.channel.history(limit=5):
                    if msg.author != self.bot.user:
                        message = msg
                        break

            if not message:
                await interaction.edit_original_response(content="âŒ Aucun message trouvÃ©.")
                return

            emoji_list = emojis.split()

            await self._react_to_message(
                channel=message.channel,
                guild=interaction.guild,
                emoji_names=emoji_list,
                reference_message_id=message.id,
            )

            await interaction.edit_original_response(content="âœ… RÃ©actions ajoutÃ©es.")

        except Exception as e:
            print(f"[ERREUR /react] {e}")
            await interaction.edit_original_response(content="âŒ Une erreur est survenue.")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commande PREFIX
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @commands.command(
        name="react",
        aliases=["r"],
        help="RÃ©agit Ã  un message avec un ou plusieurs emojis."
    )
    @commands.cooldown(rate=1, per=3, type=commands.BucketType.user)
    async def prefix_react(self, ctx: commands.Context, *emoji_names: str):
        try:
            await ctx.message.delete()
        except (discord.Forbidden, discord.HTTPException):
            pass

        await self._react_to_message(
            channel=ctx.channel,
            guild=ctx.guild,
            emoji_names=list(emoji_names),
            reference_message_id=ctx.message.reference.message_id if ctx.message.reference else None,
            before_time=ctx.message.created_at,
        )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”Œ Setup du Cog
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def setup(bot: commands.Bot):
    cog = ReactCommand(bot)
    for command in cog.get_commands():
        if not hasattr(command, "category"):
            command.category = "GÃ©nÃ©ral"
    await bot.add_cog(cog)
