# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“Œ motssecrets.py â€” Jeu des Mots Secrets multijoueur
# Objectif : Pendant 3 minutes, tout le monde peut proposer un mot secret pour gagner du Reiatsu
# CatÃ©gorie : Jeux / Fun
# AccÃ¨s : Tous
# Cooldown : 1 utilisation / 5 secondes / utilisateur
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Imports nÃ©cessaires
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import discord
from discord import app_commands
from discord.ext import commands
from utils.discord_utils import safe_send, safe_respond
from utils.supabase_client import supabase
import json
from pathlib import Path
from datetime import datetime, timedelta
import asyncio

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“‚ Chargement des donnÃ©es JSON
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MOTS_PATH = Path("data/motssecrets.json")
with MOTS_PATH.open("r", encoding="utf-8") as f:
    MOTS = json.load(f)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  Cog principal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class MotsSecretsMulti(commands.Cog):
    """
    ğŸ® Jeu des Mots Secrets Multijoueur â€” Pendant 3 minutes, proposez des mots pour gagner du Reiatsu !
    """
    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.active_games = {}  # channel_id : end_time

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”§ MÃ©thodes internes
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    def normalize(self, text: str) -> str:
        return text.strip().lower()

    async def start_game(self, channel: discord.TextChannel):
        """DÃ©marre un nouveau jeu de 3 minutes dans le channel."""
        if channel.id in self.active_games:
            await safe_send(channel, "âš ï¸ Un jeu est dÃ©jÃ  en cours ici !")
            return

        self.active_games[channel.id] = datetime.utcnow() + timedelta(minutes=3)

        embed = discord.Embed(
            title="ğŸ“ Jeu des Mots Secrets !",
            description=(
                "ğŸ’¡ Il y a 100 mots secret Ã  trouver, un mot trouvÃ© rapporte 10 reiatsu une fois par personne. "
                "Pendant **3 minutes**, proposez autant de mots que vous voulez en mettant`.` ou `*` devant.\n"
                "Exemple : `.exemple` ou `*exemple`\n\n"
                "ğŸ¯ Si le mot proposÃ© n'est pas un mot secret le bot ne rÃ©pond pas.\n"
                "âš ï¸ Si c'est un mot que vous aviez dÃ©jÃ  trouvÃ©, le bot vous le signalera.\n"
                "Bonne chance !"
            ),
            color=discord.Color.green()
        )
        embed.set_footer(text="â³ Le jeu se terminera automatiquement dans 3 minutes.")
        await safe_send(channel, embed=embed)

        # Fin automatique aprÃ¨s 3 minutes
        async def stop_later():
            await asyncio.sleep(180)
            if channel.id in self.active_games:
                await safe_send(channel, "â° Le jeu des mots secrets est terminÃ© !")
                del self.active_games[channel.id]

        asyncio.create_task(stop_later())

    async def handle_guess(self, message: discord.Message):
        """GÃ¨re la vÃ©rification dâ€™un mot proposÃ©."""
        mot_propose = self.normalize(message.content[1:])
        mot_data = [m for m in MOTS if self.normalize(m["mot"]) == mot_propose]
        if not mot_data:
            return  # mot inconnu

        mot_id = mot_data[0]["id"]
        user_id = message.author.id
        username = str(message.author)

        # RÃ©cupÃ¨re les mots dÃ©jÃ  trouvÃ©s
        user_data = supabase.table("mots_trouves").select("*").eq("user_id", user_id).execute()
        if user_data.data:
            mots_trouves = user_data.data[0].get("mots") or []
            if isinstance(mots_trouves, str):
                mots_trouves = json.loads(mots_trouves)
        else:
            mots_trouves = []

        if mot_id in mots_trouves:
            await message.reply(f"âš ï¸ {message.author.mention}, tu as dÃ©jÃ  trouvÃ© ce mot secret !")
            return

        # Ajoute le mot trouvÃ©
        mots_trouves.append(mot_id)
        if user_data.data:
            supabase.table("mots_trouves").update({
                "mots": mots_trouves,
                "last_found_at": datetime.utcnow().isoformat()
            }).eq("user_id", user_id).execute()
        else:
            supabase.table("mots_trouves").insert({
                "user_id": user_id,
                "username": username,
                "mots": mots_trouves
            }).execute()

        # Donne 10 Reiatsu
        reiatsu_data = supabase.table("reiatsu").select("*").eq("user_id", user_id).execute()
        if reiatsu_data.data:
            points = reiatsu_data.data[0].get("points") or 0
            supabase.table("reiatsu").update({"points": points + 10}).eq("user_id", user_id).execute()
        else:
            supabase.table("reiatsu").insert({
                "user_id": user_id,
                "username": username,
                "points": 10
            }).execute()

        await message.reply(f"âœ… Bravo {message.author.mention} ! Tu as trouvÃ© un mot secret et gagnes **10 Reiatsu** ğŸ‰")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commande SLASH
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @app_commands.command(
        name="motsecret",
        description="Pendant 3 minutes, cherchez l'un des 100 mots secrets pour gagner 10 Reiatsu."
    )
    @app_commands.checks.cooldown(1, 5.0, key=lambda i: i.user.id)
    async def slash_motsecret(self, interaction: discord.Interaction):
        await self.start_game(interaction.channel)
        await safe_respond(interaction, "âœ… Jeu des mots secrets lancÃ© dans ce salon !")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commande PREFIX
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @commands.command(name="motsecret", aliases=["motssecrets", "ms"], help="Pendant 3 minutes, cherchez l'un des 100 mots secrets pour gagner 10 Reiatsu.")
    @commands.cooldown(1, 5.0, commands.BucketType.user)
    async def prefix_motsecret(self, ctx: commands.Context):
        await self.start_game(ctx.channel)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ§ Ã‰vÃ©nement : Proposition de mot
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @commands.Cog.listener()
    async def on_message(self, message: discord.Message):
        if message.author.bot:
            return
        if message.channel.id not in self.active_games:
            return
        if not (message.content.startswith(".") or message.content.startswith("*")):
            return
        mot_propose = message.content[1:]
        if not mot_propose.strip():
            return  # ignore les messages comme "." ou "*"
        await self.handle_guess(message)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”Œ Setup du Cog
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def setup(bot: commands.Bot):
    cog = MotsSecretsMulti(bot)
    for command in cog.get_commands():
        if not hasattr(command, "category"):
            command.category = "Jeux"
    await bot.add_cog(cog)
