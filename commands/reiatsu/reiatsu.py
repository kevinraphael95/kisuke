# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“Œ reiatsu.py â€” Commande interactive /reiatsu et !reiatsu
# Objectif : Affiche les informations de spawn Reiatsu du serveur et le classement global
# CatÃ©gorie : Reiatsu
# AccÃ¨s : Public
# Cooldown : 1 utilisation / 3 secondes / utilisateur
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Imports nÃ©cessaires
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import discord
from discord import app_commands
from discord.ext import commands
from discord.ui import View, Button
from dateutil import parser
from datetime import datetime, timedelta, timezone
import time
import os
from utils.supabase_client import supabase
from utils.discord_utils import safe_send, safe_respond

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Tables utilisÃ©es
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TABLES = {
    "reiatsu_config": {
        "description": "Contient la configuration du spawn et du salon pour chaque serveur.",
        "columns": {
            "guild_id": "BIGINT â€” Identifiant du serveur Discord (clÃ© primaire)",
            "channel_id": "BIGINT â€” Salon de spawn",
            "message_id": "BIGINT â€” ID du message de spawn",
            "is_spawn": "BOOLEAN â€” Indique si un Reiatsu est actuellement spawnÃ©",
            "spawn_speed": "TEXT â€” ClÃ© de vitesse de spawn (Ultra_Rapide, Rapide, Normal, Lent)",
            "last_spawn_at": "TIMESTAMP â€” Dernier spawn",
            "spawn_delay": "INTEGER â€” Intervalle minimal entre les spawns en secondes"
        }
    },
    "reiatsu": {
        "description": "Contient les scores Reiatsu pour le classement global.",
        "columns": {
            "user_id": "BIGINT â€” Identifiant Discord unique de l'utilisateur (clÃ© primaire)",
            "points": "INTEGER â€” Score de Reiatsu actuel"
        }
    }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Infos intervalles de vitesse de spawn
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SPAWN_SPEED_INTERVALS = {
    "Ultra_Rapide": "1-5 minutes",
    "Rapide": "5-20 minutes",
    "Normal": "30-60 minutes",
    "Lent": "5-10 heures"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ›ï¸ Vue interactive Reiatsu (Classement)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class ReiatsuView(View):
    def __init__(self, author: discord.Member = None):
        super().__init__(timeout=None)
        self.author = author

    @discord.ui.button(label="ğŸ“Š Classement", style=discord.ButtonStyle.primary, custom_id="reiatsu:classement")
    async def classement_button(self, interaction: discord.Interaction, button: discord.ui.Button):
        if self.author and interaction.user != self.author:
            return await interaction.response.send_message("âŒ Tu ne peux pas utiliser ce bouton.", ephemeral=True)
        try:
            classement_data = supabase.table("reiatsu").select("user_id, points").order("points", desc=True).limit(10).execute()
        except Exception as e:
            print(f"[ERREUR DB] Impossible de rÃ©cupÃ©rer le classement : {e}")
            return await interaction.response.send_message("âŒ Erreur lors du chargement du classement.", ephemeral=True)
        if not classement_data.data:
            return await interaction.response.send_message("âš ï¸ Aucun classement disponible pour le moment.", ephemeral=True)

        description = ""
        for i, entry in enumerate(classement_data.data, start=1):
            user_id = int(entry["user_id"])
            points = entry["points"]
            user = interaction.guild.get_member(user_id) if interaction.guild else None
            name = user.display_name if user else f"Utilisateur ({user_id})"
            description += f"**{i}. {name}** â€” {points} points\n"

        embed = discord.Embed(title="ğŸ“Š Classement Reiatsu", description=description, color=discord.Color.purple())
        await interaction.response.send_message(embed=embed)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  Cog principal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class ReiatsuCommand(commands.Cog):
    """Commande /reiatsu et !reiatsu â€” Affiche les informations de spawn du serveur et le classement"""

    COOLDOWN = 3

    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.bot.add_view(ReiatsuView())
        self.user_cooldowns = {}

    async def _check_cooldown(self, user_id: int):
        now = time.time()
        last = self.user_cooldowns.get(user_id, 0)
        if now - last < self.COOLDOWN:
            return self.COOLDOWN - (now - last)
        self.user_cooldowns[user_id] = now
        return 0

    async def _send_server_info(self, channel_or_interaction, author, guild):
        guild_id = int(guild.id)
        try:
            config_data = supabase.table("reiatsu_config").select("*").eq("guild_id", guild_id).execute()
        except Exception as e:
            print(f"[ERREUR DB] Lecture config Ã©chouÃ©e : {e}")
            return await safe_send(channel_or_interaction, "âŒ Erreur lors de la rÃ©cupÃ©ration de la configuration du serveur.")

        config = config_data.data[0] if config_data and config_data.data else None
        salon_text, spawn_speed_text, temps_text = "âŒ", "âš ï¸ Inconnu", "âš ï¸ Inconnu"

        if config:
            salon = guild.get_channel(int(config.get("channel_id"))) if config.get("channel_id") else None
            salon_text = salon.mention if salon else "âš ï¸ Salon introuvable"
            speed_key = config.get("spawn_speed")
            spawn_speed_text = f"{SPAWN_SPEED_INTERVALS.get(speed_key, 'âš ï¸ Inconnu')} ({speed_key})" if speed_key else spawn_speed_text

            if config.get("is_spawn") and config.get("message_id"):
                temps_text = "ğŸ’  Un Reiatsu est **dÃ©jÃ  apparu** !"
            else:
                last_spawn = config.get("last_spawn_at")
                delay = config.get("spawn_delay", 1800)
                if last_spawn:
                    try:
                        last_spawn_dt = parser.parse(last_spawn)
                        if not last_spawn_dt.tzinfo:
                            last_spawn_dt = last_spawn_dt.replace(tzinfo=timezone.utc)
                        remaining = int((last_spawn_dt + timedelta(seconds=delay) - datetime.now(timezone.utc)).total_seconds())
                        if remaining <= 0:
                            temps_text = "ğŸ’  Un Reiatsu peut apparaÃ®tre **Ã  tout moment** !"
                        else:
                            minutes, seconds = divmod(remaining, 60)
                            temps_text = f"**{minutes}m {seconds}s**"
                    except Exception:
                        temps_text = "ğŸ’  Un Reiatsu peut apparaÃ®tre **Ã  tout moment** !"

        embed = discord.Embed(
            title=f"__Informations Reiatsu du serveur__",
            description=(
                f"ğŸ“ **Salon de spawn** : {salon_text}\n"
                f"â±ï¸ **Vitesse de spawn** : {spawn_speed_text}\n"
                f"â³ **Prochain spawn** : {temps_text}"
            ),
            color=discord.Color.purple()
        )
        embed.set_footer(text="ğŸ’  Utilise /reiatsuprofil pour ton profil personnel.")
        view = ReiatsuView(author)
        if isinstance(channel_or_interaction, discord.Interaction):
            await channel_or_interaction.response.send_message(embed=embed, view=view)
        else:
            await safe_send(channel_or_interaction, embed=embed, view=view)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commandes SLASH + PREFIX
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @app_commands.command(name="reiatsu", description="ğŸ’  Affiche les informations de spawn Reiatsu du serveur et le classement global.")
    async def slash_reiatsu(self, interaction: discord.Interaction):
        remaining = await self._check_cooldown(interaction.user.id)
        if remaining > 0:
            return await safe_respond(interaction, f"â³ Attends encore {remaining:.1f}s.", ephemeral=True)
        await self._send_server_info(interaction, interaction.user, interaction.guild)

    @commands.command(name="reiatsu", aliases=["rts"], help="ğŸ’  Affiche les informations de spawn Reiatsu du serveur et le classement global.")
    async def prefix_reiatsu(self, ctx: commands.Context):
        remaining = await self._check_cooldown(ctx.author.id)
        if remaining > 0:
            return await safe_send(ctx.channel, f"â³ Attends encore {remaining:.1f}s.")
        await self._send_server_info(ctx.channel, ctx.author, ctx.guild)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”Œ Setup du Cog
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def setup(bot: commands.Bot):
    cog = ReiatsuCommand(bot)
    for command in cog.get_commands():
        if not hasattr(command, "category"):
            command.category = "Reiatsu"
    await bot.add_cog(cog)
